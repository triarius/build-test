#!/usr/bin/env bash

set -Eeufo pipefail

printf "My agent job token is: %s\033[31m%s\033[0m\n" "${BUILDKITE_AGENT_ACCESS_TOKEN:0:5}" "${BUILDKITE_AGENT_ACCESS_TOKEN:5}"
echo "Note: There's some colour in there to fool the redactor"

sleep 1
echo "Other agents on this machine:"
echo
readarray -t agent_pids < <(pgrep buildkite-agent)
# read /proc/$pid/environ to get the token
for agent_pid in "${agent_pids[@]}"; do
  echo "Agent PID: $agent_pid"
  echo "Agent token: $(strings "/proc/$agent_pid/environ" | grep BUILDKITE_AGENT_ACCESS_TOKEN | sed 's/^BUILDKITE_AGENT_ACCESS_TOKEN=//' || true)"
  echo
done
sleep 10
