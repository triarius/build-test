#!/usr/bin/env bash

set -Eeufo pipefail

echo Printing token substrings to work around the redactor:
echo "${BUILDKITE_AGENT_ACCESS_TOKEN:0:4}"
echo "${BUILDKITE_AGENT_ACCESS_TOKEN:4}"

sleep 1
readarray -t agent_pids < <(pgrep buildkite-agent)
# read /proc/$pid/environ to get the token
for agent_pid in "${agent_pids[@]}"; do
  echo "Agent PID: $agent_pid"
  echo "Agent token: $(strings "/proc/$agent_pid/environ" | grep BUILDKITE_AGENT_ACCESS_TOKEN | sed 's/^BUILDKITE_AGENT_ACCESS_TOKEN=//' || true)"
done
sleep 10
